<!DOCTYPE>
<html>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>K-Chat (Work In Progress)</title>
<style type="text/css">
div.scrollable{
    overflow: scroll;
    height:50%;
}
</style>
<div>
    <h1>K-Chat (开发中)</h1>
    <div class="scrollable" id="chat_bar">
    </div>
    <div>
        <p><input type="text" id="nickname" placeholder="在此输入你的昵称" disabled></p>
        <p><textarea id="msg" placeholder="在此输入文字消息"></textarea></p>
        <p><input id="send_msg" type="button" value="发送"> 或 Enter键发送消息</p>
        <p><input id="change_nickname" type="button" value="修改昵称">
            <input id="confirm_nickname" type="button" value="确认昵称" hidden>
        </p>
    </div>
    <div>
        <p>状态: <span id="status_bar">正在连接到服务器...</span> </p>
    </div>
    <div>
        <a href="developer_log.html">开发者日志</a>
    </div>
</div>
<script src="/js/jquery.js"></script>
<script src="jquery.cookie.js"></script>
<script>
    function getTime() {
        var date = new Date()
        var y = date.getFullYear();
        var m = date.getMonth() + 1;
        m = m < 10 ? ('0' + m) : m;
        var d = date.getDate();
        d = d < 10 ? ('0' + d) : d;
        var h = date.getHours();
        h = h < 10 ? ('0' + h) : h;
        var minute = date.getMinutes();
        var second = date.getSeconds();
        minute = minute < 10 ? ('0' + minute) : minute;
        second = second < 10 ? ('0' + second) : second;
        return y + '-' + m + '-' + d+' '+h+':'+minute+':'+second;
    }

    function saveNickname() {
        console.log("Saving nickname:"+$("#nickname").val())
        $.cookie('this_nickname',escape($("#nickname").val()),{expires:3})
    }

    function getNickname() {
        var name=$.cookie('this_nickname')
        if(name==null) {
            return null
        } else {
            return unescape(name)
        }
    }

    var ws=new WebSocket("ws://kiritow.com:59505")
    ws.onopen=function() {
        console.log("onopen")
        $("#status_bar").text("已连接到服务器.")
        console.log("Sending hello broadcast...")
        if(getNickname()==null) {
            ws.send("欢迎新人~!")
            $("#nickname").removeAttr("disabled")
        } else {
            ws.send("欢迎回来,"+getNickname())
            $("#nickname").val(getNickname())
        }
        console.log("hello sent.")
    }
    ws.onclose=function(){
        console.log("onclose")
        $("#status_bar").text("连接已关闭.")
    }
    ws.onerror=function() {
        console.log("onerror")
        $("#status_bar").text("发生错误.")
    }
    ws.onmessage=function(ev) {
        $("#chat_bar").append("<p><font color=blue>"+getTime()+"</font> "+ev.data+"</p>")
        $("#chat_bar").get(0).scrollTop=$("#chat_bar").get(0).scrollHeight;
    }

    function sendMessage() {
        if($("#nickname").val()== null || $("#nickname").val()=='') {
            alert("请填写昵称!")
            return
        }
        if(getNickname()==null) {
            $("#nickname").attr("disabled","disabled")
            saveNickname()
            console.log("Sending message:"+ $("#msg").val())
            ws.send("[New]"+$("#nickname").val()+"说: "+$("#msg").val())
        } else {
            console.log("Sending message:"+ $("#msg").val())
            ws.send($("#nickname").val()+"说: "+$("#msg").val())
        }
        $("#msg").val('')
    }

    $("#send_msg").click(function(){
        sendMessage()
    })

    $("#msg").on('keypress',function(ev){
        if(ev.keyCode==13) {
            sendMessage()
            return false
        }
    })

    $("#change_nickname").click(function(){
        $("#msg").attr("disabled","disabled")
        $("#send_msg").attr("disabled","disabled")
        $("#nickname").removeAttr("disabled")
        $("#change_nickname").attr("hidden","hidden")
        $("#confirm_nickname").removeAttr("hidden")
    })

    $("#confirm_nickname").click(function(){
        if($("#nickname").val()== null || $("#nickname").val()=='') {
            alert("请填写昵称!")
            return
        }
        ws.send(getNickname()+" 修改了昵称为 "+$("#nickname").val())
        saveNickname($("#nickname").val())
        $("#nickname").attr("disabled","disabled")
        $("#confirm_nickname").attr("hidden","hidden")
        $("#change_nickname").removeAttr("hidden")
        $("#msg").removeAttr("disabled")
        $("#send_msg").removeAttr("disabled")
    })
</script>

</html>